# Baza Wiedzy - Edytor (Quill.js)

## üìã Spis tre≈õci
1. [PrzeglƒÖd](#przeglƒÖd)
2. [Quill.js Editor](#quilljs-editor)
3. [Upload obrazk√≥w](#upload-obrazk√≥w)
4. [Embed video](#embed-video)
5. [Sanityzacja HTML](#sanityzacja-html)
6. [API Reference](#api-reference)

---

## PrzeglƒÖd

Edytor Bazy Wiedzy wykorzystuje **Quill.js** - nowoczesny WYSIWYG editor z pe≈Çnym wsparciem dla:
- Formatowania tekstu (bold, italic, underline)
- Nag≈Ç√≥wk√≥w (H1, H2, H3)
- List (uporzƒÖdkowane i nieuporzƒÖdkowane)
- Link√≥w
- Obrazk√≥w (z uploadem do Supabase Storage)
- Video (YouTube/Vimeo embed)

---

## Quill.js Editor

### Inicjalizacja

Edytor jest automatycznie inicjalizowany przy starcie aplikacji (je≈õli feature flag `ENABLE_KNOWLEDGE_BASE` jest w≈ÇƒÖczony):

```javascript
// W app.js
if (featureFlags.isKnowledgeBaseEnabled()) {
  const quill = knowledgeBaseEngine.initEditor('#kb-editor-quill');
  window.knowledgeBaseQuillEditor = quill;
}
```

### Toolbar

Domy≈õlny toolbar zawiera:

```javascript
toolbar: [
  [{ 'header': [1, 2, 3, false] }],      // Nag≈Ç√≥wki H1, H2, H3
  ['bold', 'italic', 'underline'],       // Formatowanie tekstu
  [{ 'list': 'ordered'}, { 'list': 'bullet' }], // Listy
  ['link', 'image', 'video'],            // Media
  ['clean']                               // Usu≈Ñ formatowanie
]
```

### Dostƒôp do edytora

```javascript
const quill = window.knowledgeBaseQuillEditor;

// Pobierz tre≈õƒá HTML
const html = quill.root.innerHTML;

// Ustaw tre≈õƒá HTML
quill.root.innerHTML = '<p>Hello world</p>';

// Pobierz zaznaczenie
const range = quill.getSelection();

// Wstaw tekst
quill.insertText(range.index, 'Hello');

// Wstaw embed (obrazek, video)
quill.insertEmbed(range.index, 'image', 'https://example.com/image.jpg');
```

---

## Upload obrazk√≥w

### Jak to dzia≈Ça?

1. **U≈ºytkownik klika ikonƒô obrazka** w toolbarze
2. **Otwiera siƒô dialog wyboru pliku**
3. **Plik jest walidowany** (typ, rozmiar)
4. **Upload do Supabase Storage** (`knowledge-base-images` bucket)
5. **Obrazek jest wstawiany** do edytora z publicznym URL

### Walidacja

- **Dozwolone typy:** JPG, PNG, GIF, WEBP
- **Maksymalny rozmiar:** 5MB
- **Nazwa pliku:** `{timestamp}-{random}.{ext}` (unikalna)

### Kod

```javascript
// W knowledge-base-engine.js
async uploadImage(file) {
  // 1. Walidacja typu
  const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
  if (!allowedTypes.includes(file.type)) {
    throw new Error('Nieprawid≈Çowy typ pliku');
  }
  
  // 2. Walidacja rozmiaru (max 5MB)
  if (file.size > 5 * 1024 * 1024) {
    throw new Error('Plik jest za du≈ºy');
  }
  
  // 3. Generuj unikalnƒÖ nazwƒô
  const filename = `${Date.now()}-${Math.random().toString(36).substring(2, 8)}.${ext}`;
  
  // 4. Upload do Supabase Storage
  const { data, error } = await supabaseClient.storage
    .from('knowledge-base-images')
    .upload(filename, file);
  
  // 5. Pobierz publiczny URL
  const { data: { publicUrl } } = supabaseClient.storage
    .from('knowledge-base-images')
    .getPublicUrl(filename);
  
  return publicUrl;
}
```

### Custom handler w Quill

```javascript
const toolbar = quill.getModule('toolbar');
toolbar.addHandler('image', async () => {
  const input = document.createElement('input');
  input.setAttribute('type', 'file');
  input.setAttribute('accept', 'image/*');
  input.click();
  
  input.onchange = async () => {
    const file = input.files[0];
    const url = await knowledgeBaseEngine.uploadImage(file);
    
    const range = quill.getSelection(true);
    quill.insertEmbed(range.index, 'image', url);
  };
});
```

### Supabase Storage - RLS Policies

```sql
-- Admini mogƒÖ uploadowaƒá obrazki
CREATE POLICY "kb_images_insert_admin"
ON storage.objects FOR INSERT
TO authenticated
WITH CHECK (
  bucket_id = 'knowledge-base-images' AND
  auth.uid() IN (SELECT id FROM auth.users WHERE is_super_admin = TRUE)
);

-- Wszyscy mogƒÖ czytaƒá obrazki
CREATE POLICY "kb_images_select_all"
ON storage.objects FOR SELECT
TO public
USING (bucket_id = 'knowledge-base-images');
```

---

## Embed video

### Obs≈Çugiwane platformy

- **YouTube** (youtube.com, youtu.be)
- **Vimeo** (vimeo.com)

### Jak to dzia≈Ça?

1. **U≈ºytkownik klika ikonƒô video** w toolbarze
2. **Prompt z pro≈õbƒÖ o URL**
3. **Ekstrakcja video ID** z URL (regex)
4. **Wstawienie iframe** do edytora

### Kod

```javascript
// Ekstrakcja video info
extractVideoInfo(url) {
  // YouTube regex
  const youtubeRegex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
  const youtubeMatch = url.match(youtubeRegex);
  
  if (youtubeMatch && youtubeMatch[1]) {
    return { platform: 'youtube', id: youtubeMatch[1] };
  }
  
  // Vimeo regex
  const vimeoRegex = /vimeo\.com\/(?:channels\/(?:\w+\/)?|groups\/([^\/]*)\/videos\/|album\/(\d+)\/video\/|)(\d+)(?:$|\/|\?)/;
  const vimeoMatch = url.match(vimeoRegex);
  
  if (vimeoMatch && vimeoMatch[3]) {
    return { platform: 'vimeo', id: vimeoMatch[3] };
  }
  
  return { platform: null, id: null };
}

// Custom handler w Quill
toolbar.addHandler('video', () => {
  const url = prompt('Wklej link do video (YouTube lub Vimeo):');
  const videoInfo = knowledgeBaseEngine.extractVideoInfo(url);
  
  if (videoInfo.platform === 'youtube') {
    quill.insertEmbed(range.index, 'video', `https://www.youtube.com/embed/${videoInfo.id}`);
  } else if (videoInfo.platform === 'vimeo') {
    quill.insertEmbed(range.index, 'video', `https://player.vimeo.com/video/${videoInfo.id}`);
  }
});
```

### Przyk≈Çady URL

**YouTube:**
- `https://www.youtube.com/watch?v=dQw4w9WgXcQ`
- `https://youtu.be/dQw4w9WgXcQ`
- `https://www.youtube.com/embed/dQw4w9WgXcQ`

**Vimeo:**
- `https://vimeo.com/123456789`
- `https://vimeo.com/channels/staffpicks/123456789`

### HTML Output

```html
<!-- YouTube -->
<iframe 
  class="ql-video" 
  src="https://www.youtube.com/embed/dQw4w9WgXcQ"
  frameborder="0"
  allowfullscreen>
</iframe>

<!-- Vimeo -->
<iframe 
  class="ql-video" 
  src="https://player.vimeo.com/video/123456789"
  frameborder="0"
  allowfullscreen>
</iframe>
```

---

## Sanityzacja HTML

### Dlaczego?

Tre≈õƒá HTML z edytora mo≈ºe zawieraƒá potencjalnie niebezpieczny kod (XSS):
- Tagi `<script>`
- Event handlery (`onclick`, `onerror`, etc.)
- `javascript:` w linkach

### Implementacja

```javascript
sanitizeHTML(html) {
  const temp = document.createElement('div');
  temp.innerHTML = html;
  
  // 1. Usu≈Ñ tagi <script>
  const scripts = temp.querySelectorAll('script');
  scripts.forEach(script => script.remove());
  
  // 2. Usu≈Ñ event handlery (on*)
  const allElements = temp.querySelectorAll('*');
  allElements.forEach(el => {
    Array.from(el.attributes).forEach(attr => {
      if (attr.name.startsWith('on')) {
        el.removeAttribute(attr.name);
      }
    });
    
    // 3. Usu≈Ñ javascript: w href
    if (el.hasAttribute('href')) {
      const href = el.getAttribute('href');
      if (href && href.toLowerCase().startsWith('javascript:')) {
        el.removeAttribute('href');
      }
    }
  });
  
  return temp.innerHTML;
}
```

### U≈ºycie

```javascript
// Przed zapisem do bazy
const rawHTML = quill.root.innerHTML;
const safeHTML = knowledgeBaseEngine.sanitizeHTML(rawHTML);

await dataService.createKnowledgeBaseArticle({
  title: 'My Article',
  content: safeHTML  // ‚úÖ Bezpieczny HTML
});
```

### Uwaga: DOMPurify

Dla produkcji zalecane jest u≈ºycie biblioteki **DOMPurify**:

```html
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
```

```javascript
const clean = DOMPurify.sanitize(dirty, {
  ALLOWED_TAGS: ['p', 'br', 'strong', 'em', 'u', 'h1', 'h2', 'h3', 'ul', 'ol', 'li', 'a', 'img', 'iframe'],
  ALLOWED_ATTR: ['href', 'src', 'alt', 'title', 'class', 'style']
});
```

---

## API Reference

### `knowledgeBaseEngine.initEditor(container, options)`

Inicjalizuje Quill.js editor.

**Parametry:**
- `container` (string|HTMLElement) - Kontener dla edytora
- `options` (Object, opcjonalny) - Opcje Quill

**Zwraca:** `Object|null` - Instancja Quill lub null

**Przyk≈Çad:**
```javascript
const quill = knowledgeBaseEngine.initEditor('#editor', {
  theme: 'snow',
  placeholder: 'Napisz co≈õ...'
});
```

---

### `knowledgeBaseEngine.uploadImage(file)`

Uploaduje obrazek do Supabase Storage.

**Parametry:**
- `file` (File) - Plik obrazka

**Zwraca:** `Promise<string>` - Publiczny URL obrazka

**B≈Çƒôdy:**
- `'Nieprawid≈Çowy typ pliku'` - Nieobs≈Çugiwany format
- `'Plik jest za du≈ºy'` - Przekroczono 5MB

**Przyk≈Çad:**
```javascript
const url = await knowledgeBaseEngine.uploadImage(file);
console.log('Image URL:', url);
```

---

### `knowledgeBaseEngine.embedVideo(url)`

Generuje HTML embed dla video.

**Parametry:**
- `url` (string) - URL video (YouTube/Vimeo)

**Zwraca:** `string|null` - HTML embed lub null

**Przyk≈Çad:**
```javascript
const embed = knowledgeBaseEngine.embedVideo('https://youtube.com/watch?v=...');
// => '<div class="video-embed">...</div>'
```

---

### `knowledgeBaseEngine.extractVideoInfo(url)`

Ekstrahuje informacje o video z URL.

**Parametry:**
- `url` (string) - URL video

**Zwraca:** `{platform: string|null, id: string|null}`

**Przyk≈Çad:**
```javascript
const info = knowledgeBaseEngine.extractVideoInfo('https://youtube.com/watch?v=dQw4w9WgXcQ');
// => { platform: 'youtube', id: 'dQw4w9WgXcQ' }
```

---

### `knowledgeBaseEngine.sanitizeHTML(html)`

Sanityzuje HTML (usuwa niebezpieczny kod).

**Parametry:**
- `html` (string) - HTML do sanityzacji

**Zwraca:** `string` - Bezpieczny HTML

**Przyk≈Çad:**
```javascript
const safe = knowledgeBaseEngine.sanitizeHTML('<p onclick="alert()">Hello</p>');
// => '<p>Hello</p>'
```

---

### `knowledgeBaseEngine.generateSlug(title)`

Generuje URL-friendly slug z tytu≈Çu.

**Parametry:**
- `title` (string) - Tytu≈Ç artyku≈Çu

**Zwraca:** `string` - Slug

**Przyk≈Çad:**
```javascript
const slug = knowledgeBaseEngine.generateSlug('Jak zaczƒÖƒá trening?');
// => 'jak-zaczac-trening'
```

---

### `knowledgeBaseEngine.parseTags(tagsString)`

Parsuje tagi z ciƒÖgu znak√≥w do tablicy.

**Parametry:**
- `tagsString` (string) - Tagi oddzielone przecinkami

**Zwraca:** `string[]` - Tablica tag√≥w

**Przyk≈Çad:**
```javascript
const tags = knowledgeBaseEngine.parseTags('trening, fitness, si≈Ça');
// => ['trening', 'fitness', 'si≈Ça']
```

---

### `knowledgeBaseEngine.formatTags(tagsArray)`

Formatuje tablicƒô tag√≥w do ciƒÖgu znak√≥w.

**Parametry:**
- `tagsArray` (string[]) - Tablica tag√≥w

**Zwraca:** `string` - Tagi oddzielone przecinkami

**Przyk≈Çad:**
```javascript
const str = knowledgeBaseEngine.formatTags(['trening', 'fitness']);
// => 'trening, fitness'
```

---

### `knowledgeBaseEngine.validateArticle(article)`

Waliduje dane artyku≈Çu przed zapisem.

**Parametry:**
- `article` (KnowledgeBaseArticleInput) - Dane artyku≈Çu

**Zwraca:** `{valid: boolean, errors: string[]}`

**Przyk≈Çad:**
```javascript
const result = knowledgeBaseEngine.validateArticle({
  title: 'My Article',
  slug: 'my-article',
  content: '<p>Content</p>'
});

if (!result.valid) {
  console.error('Validation errors:', result.errors);
}
```

---

## üéØ Podsumowanie

### ‚úÖ Co zosta≈Ço zaimplementowane:

1. **Quill.js Editor** z pe≈Çnym toolbarem
2. **Upload obrazk√≥w** do Supabase Storage
3. **Embed video** (YouTube/Vimeo)
4. **Sanityzacja HTML** (usuwanie XSS)
5. **Walidacja danych** artyku≈Çu
6. **Generowanie slug** z polskimi znakami
7. **Parsowanie tag√≥w**

### üîí Bezpiecze≈Ñstwo:

- ‚úÖ Walidacja typu i rozmiaru plik√≥w
- ‚úÖ Unikalne nazwy plik√≥w
- ‚úÖ RLS policies w Supabase Storage
- ‚úÖ Sanityzacja HTML przed zapisem
- ‚úÖ Tylko admini mogƒÖ uploadowaƒá

### üìö Dokumentacja:

- ‚úÖ API Reference
- ‚úÖ Przyk≈Çady kodu
- ‚úÖ Instrukcje u≈ºycia

---

**Ostatnia aktualizacja:** 2025-10-30

