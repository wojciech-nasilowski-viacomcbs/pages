# üèóÔ∏è Plan Refaktoringu Architektury eTrener - WERSJA FINALNA

**Data**: 1 listopada 2025  
**Status**: ‚úÖ **ZATWIERDZONY DO IMPLEMENTACJI**  
**Autorzy**: Zesp√≥≈Ç Architektury (synteza 2 analiz)  
**Czas realizacji**: 10-12 dni roboczych

---

## üìã Executive Summary

Ten dokument zawiera **ostateczny, zatwierdzony plan refaktoringu** aplikacji eTrener. Jest to synteza dw√≥ch niezale≈ºnych analiz architektonicznych, kt√≥ra ≈ÇƒÖczy:
- ‚úÖ Szczeg√≥≈Çowy plan krok√≥w refaktoringu
- ‚úÖ Pragmatyczne podej≈õcie do narzƒôdzi (build tools)
- ‚úÖ BezpiecznƒÖ strategiƒô migracji (Strangler Fig Pattern)
- ‚úÖ Uwzglƒôdnienie aspekt√≥w systemowych (skalowanie, b≈Çƒôdy, testy)

### Kluczowe Problemy do RozwiƒÖzania:

1. **üî¥ KRYTYCZNE: Duplikacja zarzƒÖdzania stanem** (3 r√≥≈ºne sposoby)
2. **üî¥ KRYTYCZNE: God Object** (`content-manager.js` - 2015 linii)
3. **üü° ≈öREDNIE: Niesp√≥jne wzorce silnik√≥w** (IIFE vs ES6)
4. **üü° ≈öREDNIE: Brak build tools** (network waterfall przy wielu modu≈Çach)
5. **üü¢ DROBNE: Organizacja katalog√≥w** (wszystko w `/js/`)

---

## üéØ Docelowa Architektura

### Struktura Katalog√≥w (Target State):

```
/js/
  ‚îú‚îÄ‚îÄ core/                     # Warstwa jƒÖdra
  ‚îÇ   ‚îú‚îÄ‚îÄ app.js                # Main entry point
  ‚îÇ   ‚îú‚îÄ‚îÄ router.js             # Centralna nawigacja
  ‚îÇ   ‚îî‚îÄ‚îÄ config.js             # Konfiguracja
  ‚îÇ
  ‚îú‚îÄ‚îÄ state/                    # ZarzƒÖdzanie stanem
  ‚îÇ   ‚îú‚îÄ‚îÄ store.js              # Generic reactive store
  ‚îÇ   ‚îî‚îÄ‚îÄ app-state.js          # Globalny stan aplikacji
  ‚îÇ
  ‚îú‚îÄ‚îÄ services/                 # Warstwa serwis√≥w
  ‚îÇ   ‚îú‚îÄ‚îÄ auth-service.js       # Autentykacja
  ‚îÇ   ‚îú‚îÄ‚îÄ data-service.js       # CRUD Supabase (+ paginacja)
  ‚îÇ   ‚îú‚îÄ‚îÄ session-service.js    # Sesje u≈ºytkownika
  ‚îÇ   ‚îú‚îÄ‚îÄ import-service.js     # ‚Üê NOWY: Import JSON
  ‚îÇ   ‚îú‚îÄ‚îÄ export-service.js     # ‚Üê NOWY: Eksport JSON
  ‚îÇ   ‚îú‚îÄ‚îÄ ai-service.js         # ‚Üê NOWY: Generator AI
  ‚îÇ   ‚îú‚îÄ‚îÄ validation-service.js # ‚Üê NOWY: Walidacja danych
  ‚îÇ   ‚îî‚îÄ‚îÄ error-handler.js      # ‚Üê NOWY: Centralna obs≈Çuga b≈Çƒôd√≥w
  ‚îÇ
  ‚îú‚îÄ‚îÄ engines/                  # Silniki tre≈õci
  ‚îÇ   ‚îú‚îÄ‚îÄ base-engine.js        # ‚Üê NOWY: Bazowa klasa
  ‚îÇ   ‚îú‚îÄ‚îÄ quiz-engine.js        # Refactored (class + local state)
  ‚îÇ   ‚îú‚îÄ‚îÄ workout-engine.js     # Refactored (class + local state)
  ‚îÇ   ‚îú‚îÄ‚îÄ listening-engine.js   # Refactored (class + local state)
  ‚îÇ   ‚îî‚îÄ‚îÄ kb-engine.js          # ‚Üê NOWY: Kompletny silnik KB
  ‚îÇ
  ‚îú‚îÄ‚îÄ ui/                       # Warstwa UI
  ‚îÇ   ‚îú‚îÄ‚îÄ components/
  ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ card-renderer.js  # Renderowanie kart
  ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ modal-manager.js  # Modale
  ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tab-bar.js        # Tab bar
  ‚îÇ   ‚îú‚îÄ‚îÄ screens/
  ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main-screen.js
  ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ quiz-screen.js
  ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ workout-screen.js
  ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ listening-screen.js
  ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ kb-screen.js
  ‚îÇ   ‚îî‚îÄ‚îÄ ui-manager.js         # Orkiestracja UI (refactored)
  ‚îÇ
  ‚îú‚îÄ‚îÄ utils/                    # Narzƒôdzia
  ‚îÇ   ‚îú‚îÄ‚îÄ dom-helpers.js
  ‚îÇ   ‚îú‚îÄ‚îÄ audio.js
  ‚îÇ   ‚îú‚îÄ‚îÄ wake-lock.js
  ‚îÇ   ‚îî‚îÄ‚îÄ format-helpers.js     # ‚Üê NOWY
  ‚îÇ
  ‚îú‚îÄ‚îÄ data/                     # Warstwa danych
  ‚îÇ   ‚îú‚îÄ‚îÄ supabase-client.js
  ‚îÇ   ‚îú‚îÄ‚îÄ ai-prompts.js
  ‚îÇ   ‚îî‚îÄ‚îÄ feature-flags.js
  ‚îÇ
  ‚îî‚îÄ‚îÄ types.js                  # Typy JSDoc (global)
```

### Kluczowe Zasady Architektury:

1. **Hybrydowe ZarzƒÖdzanie Stanem**:
   - `appState` (globalny) ‚Üí TYLKO user, navigation, currentTab
   - Lokalne store'y w silnikach ‚Üí quizState, workoutState (enkapsulowane w klasach)
   
2. **Single Responsibility Principle**:
   - Ka≈ºdy modu≈Ç robi jednƒÖ rzecz
   - `content-manager.js` (2015 linii) ‚Üí 6 mniejszych serwis√≥w

3. **Jednolity Interfejs Silnik√≥w**:
   - Wszystkie silniki dziedziczƒÖ po `BaseEngine`
   - Wsp√≥lne metody: `init()`, `start()`, `pause()`, `resume()`, `stop()`

4. **ES6 Modules + Build Tools**:
   - Vite dla dev (HMR) i produkcji (bundling)
   - Eliminacja `window.*` API

---

## üìù Plan Implementacji (16 Krok√≥w)

### ‚öôÔ∏è FAZA 0: Setup Build Tools (NOWY!)

#### **KROK 0: Konfiguracja Vite**
**Priorytet**: üî¥ KRYTYCZNY  
**Czas**: 2-3 godziny  
**Dlaczego**: Bez build tools, modu≈Çy ES6 spowodujƒÖ "network waterfall" (30+ osobnych request√≥w HTTP)

**Akcje**:
```bash
# 1. Instalacja Vite
npm install --save-dev vite

# 2. Utworzenie vite.config.js
```

**Zawarto≈õƒá `vite.config.js`**:
```javascript
import { defineConfig } from 'vite';

export default defineConfig({
  root: '.',
  build: {
    outDir: 'dist',
    rollupOptions: {
      input: {
        main: './index.html'
      }
    }
  },
  server: {
    port: 3000,
    open: true
  }
});
```

**Update `package.json`**:
```json
{
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview",
    "test": "jest"
  }
}
```

**Update `.gitignore`**:
```
dist/
```

**‚úÖ Test**:
```bash
npm run dev    # Powinno uruchomiƒá dev server na localhost:3000
npm run build  # Powinno zbudowaƒá do /dist/
```

**‚ö†Ô∏è UWAGA**: Po tym kroku aplikacja powinna dzia≈Çaƒá identycznie jak przed refaktoringiem!

---

### üìÅ FAZA 1: Przygotowanie Struktury (Kroki 1-3)

#### **KROK 1: Utworzenie nowej struktury katalog√≥w**
**Priorytet**: üü¢ NISKI (przygotowanie)  
**Czas**: 5 minut

**Akcje**:
```bash
cd /Users/nasiloww/Documents/Projects/pages
mkdir -p js/core js/state js/services js/engines js/ui/components js/ui/screens js/utils js/data
```

**‚úÖ Test**: `npm test` - wszystkie testy przechodzƒÖ (≈ºadne zmiany w kodzie)

---

#### **KROK 2: Refactoring `state-manager.js` ‚Üí `state/store.js`**
**Priorytet**: üü° ≈öREDNI  
**Czas**: 30 minut

**Akcje**:
```bash
# 1. Przenie≈õ plik
mv js/state-manager.js js/state/store.js

# 2. Update imports w js/ui-state.js
```

**Zmiana w `js/ui-state.js`**:
```javascript
// PRZED:
import { createStore } from './state-manager.js';

// PO:
import { createStore } from './state/store.js';
```

**‚úÖ Test**: `npm test` - sprawd≈∫ czy `ui-state.js` dzia≈Ça

---

#### **KROK 3: Utworzenie `app-state.js` (z backward compatibility)**
**Priorytet**: üî¥ WYSOKI  
**Czas**: 1-2 godziny

**‚ö†Ô∏è WA≈ªNE**: `appState` zawiera TYLKO globalne dane. Silniki zachowujƒÖ swoje lokalne store'y!

**Nowy plik: `js/state/app-state.js`**:
```javascript
/**
 * @fileoverview Centralny, reaktywny store aplikacji
 * ZAWIERA TYLKO: user, navigation, currentTab
 * NIE ZAWIERA: szczeg√≥≈Ç√≥w aktywno≈õci (quizState, workoutState - to w silnikach!)
 */

import { createStore } from './store.js';

// G≈Ç√≥wny store aplikacji
export const appState = createStore({
  // User & Auth
  currentUser: null,
  userRole: 'user',
  
  // Navigation (single source of truth!)
  currentScreen: 'loading',
  currentTab: 'workouts', // workouts | quizzes | listening | knowledge-base | more
  
  // UI State
  isActivity: false,
  showTabBar: true,
  isListeningPlayerActive: false
});

// Helper functions dla ≈Çatwiejszego u≈ºycia
export function setCurrentUser(user) {
  appState.setState({ currentUser: user });
}

export function setUserRole(role) {
  appState.setState({ userRole: role });
}

export function setCurrentScreen(screen) {
  appState.setState({ currentScreen: screen });
}

export function setCurrentTab(tab) {
  appState.setState({ currentTab: tab });
  // Zapisz do localStorage
  localStorage.setItem('lastTab', tab);
}

export function setActivity(isActivity) {
  appState.setState({ isActivity });
}

export function setTabBarVisibility(show) {
  appState.setState({ showTabBar: show });
}

export function setListeningPlayerActive(active) {
  appState.setState({ isListeningPlayerActive: active });
}

// Eksport do window (backward compatibility - TEMPORARY!)
if (typeof window !== 'undefined') {
  window.appState = appState;
}
```

**Update `js/app.js` - dodaj synchronizacjƒô (DUPLIKACJA TYMCZASOWA!)**:
```javascript
// Na poczƒÖtku pliku
import { appState, setCurrentUser, setCurrentTab } from './state/app-state.js';

// Stan aplikacji (STARY - zachowaj na razie!)
const state = {
  currentView: 'main',
  currentTab: 'workouts',
  quizzes: [],
  workouts: [],
  listeningSets: [],
  currentUser: null
};
window.state = state; // Backward compatibility

// NOWE: Synchronizuj oba stany
appState.subscribe((newState, prevState) => {
  // Sync old state with new state
  if (newState.currentUser !== prevState.currentUser) {
    state.currentUser = newState.currentUser;
  }
  if (newState.currentTab !== prevState.currentTab) {
    state.currentTab = newState.currentTab;
  }
  if (newState.currentScreen !== prevState.currentScreen) {
    state.currentView = newState.currentScreen;
  }
});

// W funkcjach, gdzie aktualizujesz state, dodaj te≈º appState:
async function handleAuthStateChange(event, session) {
  if (session?.user) {
    state.currentUser = session.user;
    setCurrentUser(session.user); // ‚Üê DODAJ TO
    // ...
  }
}
```

**‚úÖ Test**: 
```bash
npm test
# + Test manualny: sprawd≈∫ czy logowanie dzia≈Ça, nawigacja dzia≈Ça
```

---

### ‚úÇÔ∏è FAZA 2: Rozdzielenie God Object (Kroki 4-8)

#### **KROK 4: Ekstrakcja `validation-service.js`**
**Priorytet**: üî¥ WYSOKI (fundament dla innych serwis√≥w)  
**Czas**: 2-3 godziny

**Dlaczego najpierw?** Import i AI service potrzebujƒÖ walidacji.

**Nowy plik: `js/services/validation-service.js`**:
```javascript
/**
 * @fileoverview Serwis walidacji danych (quiz, workout, listening)
 */

export class ValidationService {
  /**
   * Waliduje dane wed≈Çug typu
   * @param {Object} data - Dane do walidacji
   * @param {'quiz'|'workout'|'listening'} type - Typ tre≈õci
   * @returns {string[]} - Tablica b≈Çƒôd√≥w (pusta = OK)
   */
  validate(data, type) {
    switch(type) {
      case 'quiz':
        return this.validateQuiz(data);
      case 'workout':
        return this.validateWorkout(data);
      case 'listening':
        return this.validateListening(data);
      default:
        return [`Unknown content type: ${type}`];
    }
  }

  validateQuiz(data) {
    const errors = [];
    
    // Skopiuj logikƒô z content-manager.js validateQuizJSON()
    if (!data.title || typeof data.title !== 'string') {
      errors.push('Missing or invalid title');
    }
    
    if (!data.icon || typeof data.icon !== 'string') {
      errors.push('Missing or invalid icon (emoji)');
    }
    
    if (!Array.isArray(data.questions) || data.questions.length === 0) {
      errors.push('Missing or empty questions array');
    }
    
    // Walidacja ka≈ºdego pytania
    data.questions?.forEach((q, idx) => {
      if (!q.question) errors.push(`Question ${idx + 1}: missing question text`);
      if (!Array.isArray(q.options) || q.options.length < 2) {
        errors.push(`Question ${idx + 1}: need at least 2 options`);
      }
      if (typeof q.correctAnswer !== 'number' || q.correctAnswer < 0) {
        errors.push(`Question ${idx + 1}: invalid correctAnswer`);
      }
    });
    
    return errors;
  }

  validateWorkout(data) {
    const errors = [];
    
    // Skopiuj logikƒô z content-manager.js validateWorkoutJSON()
    if (!data.title || typeof data.title !== 'string') {
      errors.push('Missing or invalid title');
    }
    
    if (!data.icon || typeof data.icon !== 'string') {
      errors.push('Missing or invalid icon (emoji)');
    }
    
    if (!Array.isArray(data.phases) || data.phases.length === 0) {
      errors.push('Missing or empty phases array');
    }
    
    // Walidacja ka≈ºdej fazy
    data.phases?.forEach((phase, idx) => {
      if (!phase.name) errors.push(`Phase ${idx + 1}: missing name`);
      if (!Array.isArray(phase.exercises)) {
        errors.push(`Phase ${idx + 1}: missing exercises array`);
      }
    });
    
    return errors;
  }

  validateListening(data) {
    const errors = [];
    
    if (!data.title || typeof data.title !== 'string') {
      errors.push('Missing or invalid title');
    }
    
    if (!data.icon || typeof data.icon !== 'string') {
      errors.push('Missing or invalid icon (emoji)');
    }
    
    if (!data.sourceLang || !data.targetLang) {
      errors.push('Missing sourceLang or targetLang');
    }
    
    if (!Array.isArray(data.phrases) || data.phrases.length === 0) {
      errors.push('Missing or empty phrases array');
    }
    
    return errors;
  }
}

// Singleton instance
export const validationService = new ValidationService();
```

**‚úÖ Test**: Utw√≥rz test `__tests__/validation-service.test.js`:
```javascript
import { ValidationService } from '../js/services/validation-service.js';

describe('ValidationService', () => {
  const service = new ValidationService();
  
  test('validates correct quiz', () => {
    const quiz = {
      title: 'Test Quiz',
      icon: 'üìù',
      questions: [
        {
          question: 'Q1?',
          options: ['A', 'B'],
          correctAnswer: 0
        }
      ]
    };
    
    expect(service.validate(quiz, 'quiz')).toEqual([]);
  });
  
  test('detects missing title', () => {
    const quiz = { icon: 'üìù', questions: [] };
    const errors = service.validate(quiz, 'quiz');
    expect(errors).toContain('Missing or invalid title');
  });
  
  // ... wiƒôcej test√≥w
});
```

```bash
npm test
```

---

#### **KROK 5: Ekstrakcja `import-service.js`**
**Priorytet**: üî¥ WYSOKI  
**Czas**: 3-4 godziny

**Nowy plik: `js/services/import-service.js`**:
```javascript
/**
 * @fileoverview Serwis importu JSON (quiz, workout, listening)
 */

import { validationService } from './validation-service.js';
import { dataService } from '../data-service.js'; // Existing

export class ImportService {
  constructor() {
    this.currentImportType = 'quiz';
    this.selectedFile = null;
  }

  /**
   * Import z pliku
   */
  async importFromFile(file, type, isPublic = false) {
    try {
      const text = await file.text();
      const data = JSON.parse(text);
      return await this.import(data, type, isPublic);
    } catch (error) {
      throw new Error(`Failed to parse JSON: ${error.message}`);
    }
  }

  /**
   * Import z JSON string
   */
  async importFromJSON(jsonString, type, isPublic = false) {
    try {
      const data = JSON.parse(jsonString);
      return await this.import(data, type, isPublic);
    } catch (error) {
      throw new Error(`Invalid JSON: ${error.message}`);
    }
  }

  /**
   * G≈Ç√≥wna logika importu
   */
  async import(data, type, isPublic = false) {
    // 1. Convert legacy format (je≈õli potrzeba)
    data = this.convertLegacyFormat(data, type);
    
    // 2. Validate
    const errors = validationService.validate(data, type);
    if (errors.length > 0) {
      throw new Error(`Validation failed:\n${errors.join('\n')}`);
    }
    
    // 3. Save to Supabase
    let result;
    if (type === 'quiz') {
      result = await dataService.saveQuiz(data, isPublic);
    } else if (type === 'workout') {
      result = await dataService.saveWorkout(data, isPublic);
    } else if (type === 'listening') {
      result = await dataService.createListeningSet(
        data.title,
        data.icon,
        data.sourceLang,
        data.targetLang,
        data.phrases,
        isPublic
      );
    } else {
      throw new Error(`Unknown type: ${type}`);
    }
    
    return result;
  }

  /**
   * Konwersja starych format√≥w (backward compatibility)
   */
  convertLegacyFormat(data, type) {
    // Skopiuj logikƒô z content-manager.js
    // np. dodanie icon je≈õli brakuje, konwersja starych p√≥l, etc.
    
    if (type === 'quiz' && !data.icon) {
      data.icon = 'üìù'; // Default icon
    }
    
    if (type === 'workout' && !data.icon) {
      data.icon = 'üí™';
    }
    
    if (type === 'listening' && !data.icon) {
      data.icon = 'üéß';
    }
    
    return data;
  }
}

// Singleton
export const importService = new ImportService();
```

**Update `js/content-manager.js` - dodaj backward compatibility wrapper**:
```javascript
// Na poczƒÖtku pliku
import { importService } from './services/import-service.js';

// W obiekcie contentManager, zamie≈Ñ handleImport:
async handleImport(state, elements, uiManager) {
  const fileInput = elements.importFileInput;
  const file = fileInput.files[0];
  
  if (!file) {
    uiManager.showError('Wybierz plik JSON');
    return;
  }
  
  const type = this.currentImportType; // 'quiz' | 'workout' | 'listening'
  const isPublic = elements.importPublicCheckbox?.checked || false;
  
  try {
    elements.importButton.disabled = true;
    elements.importButton.textContent = 'Importujƒô...';
    
    // DELEGUJ do serwisu
    const result = await importService.importFromFile(file, type, isPublic);
    
    uiManager.showSuccess(`Zaimportowano: ${result.title}`);
    
    // Reload data
    await this.loadData(state, elements, uiManager);
    
    // Close modal
    elements.importModal.classList.add('hidden');
    fileInput.value = '';
    
  } catch (error) {
    console.error('Import error:', error);
    uiManager.showError(error.message);
  } finally {
    elements.importButton.disabled = false;
    elements.importButton.textContent = 'Importuj';
  }
}
```

**‚úÖ Test**: 
```bash
npm test
# + Test manualny: spr√≥buj zaimportowaƒá quiz/workout/listening
```

---

#### **KROK 6: Ekstrakcja `ai-service.js`**
**Priorytet**: üü° ≈öREDNI  
**Czas**: 3-4 godziny

**Nowy plik: `js/services/ai-service.js`**:
```javascript
/**
 * @fileoverview Serwis generowania tre≈õci przez AI
 */

import { validationService } from './validation-service.js';
import { AI_PROMPTS } from '../ai-prompts.js';

export class AIService {
  /**
   * Generuje tre≈õƒá przez AI
   * @param {string} userPrompt - Prompt u≈ºytkownika
   * @param {'quiz'|'workout'|'listening'} contentType - Typ tre≈õci
   * @param {Object} options - Opcje (np. sourceLang, targetLang dla listening)
   * @returns {Promise<Object>} - Wygenerowane dane
   */
  async generate(userPrompt, contentType, options = {}) {
    // 1. Przygotuj system prompt
    let systemPrompt = AI_PROMPTS[contentType];
    
    if (!systemPrompt) {
      throw new Error(`No AI prompt template for type: ${contentType}`);
    }
    
    // Zamie≈Ñ placeholder
    systemPrompt = systemPrompt.replace('{USER_PROMPT}', userPrompt);
    
    // Dla listening: zamie≈Ñ kody jƒôzyk√≥w
    if (contentType === 'listening') {
      systemPrompt = systemPrompt
        .replace('{SOURCE_LANG}', options.sourceLang || 'English')
        .replace('{TARGET_LANG}', options.targetLang || 'Polish');
    }
    
    // 2. Wywo≈Çaj API
    const responseText = await this.callAPI(systemPrompt, contentType);
    
    // 3. Parse JSON
    const data = this.parseJSON(responseText);
    
    // 4. Validate
    const errors = validationService.validate(data, contentType);
    if (errors.length > 0) {
      console.error('AI generated invalid data:', errors);
      throw new Error(`AI wygenerowa≈Ço nieprawid≈Çowe dane:\n${errors.join('\n')}`);
    }
    
    return data;
  }

  /**
   * Wywo≈Çanie API (Vercel Function lub OpenRouter)
   */
  async callAPI(systemPrompt, contentType) {
    const isVercel = this.detectEnvironment();
    
    if (isVercel) {
      return await this.callVercelFunction(systemPrompt, contentType);
    } else {
      return await this.callOpenRouter(systemPrompt, contentType);
    }
  }

  /**
   * Wykryj ≈õrodowisko (Vercel vs local)
   */
  detectEnvironment() {
    return window.location.hostname.includes('vercel.app') || 
           window.location.hostname.includes('pages-');
  }

  /**
   * Vercel Serverless Function
   */
  async callVercelFunction(systemPrompt, contentType) {
    const response = await fetch('/api/ai-generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        prompt: systemPrompt,
        contentType: contentType
      })
    });
    
    if (!response.ok) {
      const error = await response.text();
      throw new Error(`API error: ${error}`);
    }
    
    const data = await response.json();
    return data.content;
  }

  /**
   * OpenRouter API (local dev)
   */
  async callOpenRouter(systemPrompt, contentType) {
    // Skopiuj logikƒô z content-manager.js callAIAPI()
    const apiKey = window.CONFIG?.OPENROUTER_API_KEY;
    
    if (!apiKey) {
      throw new Error('Brak klucza API. Skonfiguruj js/config.js');
    }
    
    const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${apiKey}`,
        'Content-Type': 'application/json',
        'HTTP-Referer': window.location.origin,
        'X-Title': 'eTrener'
      },
      body: JSON.stringify({
        model: 'anthropic/claude-3.5-sonnet',
        messages: [
          { role: 'system', content: systemPrompt }
        ],
        temperature: 0.7,
        max_tokens: 4000
      })
    });
    
    if (!response.ok) {
      throw new Error(`OpenRouter API error: ${response.statusText}`);
    }
    
    const data = await response.json();
    return data.choices[0].message.content;
  }

  /**
   * Parse JSON z odpowiedzi AI (mo≈ºe byƒá w ```json``` bloku)
   */
  parseJSON(text) {
    // Usu≈Ñ markdown code blocks je≈õli sƒÖ
    let jsonText = text.trim();
    
    if (jsonText.startsWith('```json')) {
      jsonText = jsonText.replace(/```json\n?/, '').replace(/\n?```$/, '');
    } else if (jsonText.startsWith('```')) {
      jsonText = jsonText.replace(/```\n?/, '').replace(/\n?```$/, '');
    }
    
    try {
      return JSON.parse(jsonText);
    } catch (error) {
      console.error('Failed to parse AI response:', jsonText);
      throw new Error(`Nie uda≈Ço siƒô sparsowaƒá odpowiedzi AI: ${error.message}`);
    }
  }
}

// Singleton
export const aiService = new AIService();
```

**Update `js/content-manager.js`**:
```javascript
import { aiService } from './services/ai-service.js';

// Zamie≈Ñ handleAIGenerate:
async handleAIGenerate(state, elements, uiManager) {
  const userPrompt = elements.aiPromptInput.value.trim();
  
  if (!userPrompt) {
    uiManager.showError('Wpisz prompt dla AI');
    return;
  }
  
  const contentType = this.currentAIType; // 'quiz' | 'workout' | 'listening'
  
  try {
    elements.aiGenerateButton.disabled = true;
    elements.aiGenerateButton.textContent = 'Generujƒô...';
    
    // Opcje dla listening
    const options = {};
    if (contentType === 'listening') {
      options.sourceLang = elements.aiSourceLang?.value || 'English';
      options.targetLang = elements.aiTargetLang?.value || 'Polish';
    }
    
    // DELEGUJ do serwisu
    const data = await aiService.generate(userPrompt, contentType, options);
    
    // Poka≈º preview
    elements.aiPreview.textContent = JSON.stringify(data, null, 2);
    elements.aiPreviewContainer.classList.remove('hidden');
    
    // Zapisz do tymczasowej zmiennej
    this.generatedData = data;
    
  } catch (error) {
    console.error('AI generation error:', error);
    uiManager.showError(error.message);
  } finally {
    elements.aiGenerateButton.disabled = false;
    elements.aiGenerateButton.textContent = 'Generuj';
  }
}
```

**‚úÖ Test**: Test manualny generowania AI

---

#### **KROK 7: Ekstrakcja `export-service.js`**
**Priorytet**: üü¢ NISKI  
**Czas**: 1-2 godziny

**Nowy plik: `js/services/export-service.js`**:
```javascript
/**
 * @fileoverview Serwis eksportu tre≈õci do JSON
 */

import { dataService } from '../data-service.js';

export class ExportService {
  /**
   * Eksportuje tre≈õƒá do pliku JSON
   * @param {string} id - ID tre≈õci
   * @param {'quiz'|'workout'|'listening'} type - Typ tre≈õci
   */
  async export(id, type) {
    // 1. Pobierz pe≈Çne dane
    let data, filename;
    
    if (type === 'quiz') {
      data = await dataService.fetchQuizById(id);
      filename = `quiz-${this.sanitizeFilename(data.title)}.json`;
    } else if (type === 'workout') {
      data = await dataService.fetchWorkoutById(id);
      filename = `workout-${this.sanitizeFilename(data.title)}.json`;
    } else if (type === 'listening') {
      data = await dataService.fetchListeningSetById(id);
      filename = `listening-${this.sanitizeFilename(data.title)}.json`;
    } else {
      throw new Error(`Unknown type: ${type}`);
    }
    
    // 2. Wyczy≈õƒá dane (usu≈Ñ metadata Supabase)
    const cleanData = this.cleanData(data, type);
    
    // 3. Download
    this.downloadJSON(cleanData, filename);
  }

  /**
   * Usuwa metadata Supabase
   */
  cleanData(data, type) {
    const clean = { ...data };
    
    // Usu≈Ñ pola Supabase
    delete clean.id;
    delete clean.user_id;
    delete clean.created_at;
    delete clean.updated_at;
    delete clean.is_public;
    
    return clean;
  }

  /**
   * Sanityzuje nazwƒô pliku
   */
  sanitizeFilename(title) {
    return title
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/^-|-$/g, '')
      .substring(0, 50);
  }

  /**
   * Pobiera plik JSON
   */
  downloadJSON(data, filename) {
    const json = JSON.stringify(data, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    
    URL.revokeObjectURL(url);
  }
}

// Singleton
export const exportService = new ExportService();
```

**Update `js/content-manager.js`**:
```javascript
import { exportService } from './services/export-service.js';

async exportContent(id, state, elements) {
  // Okre≈õl typ na podstawie currentTab
  const type = state.currentTab; // 'quizzes' | 'workouts' | 'listening'
  const normalizedType = type.replace(/s$/, ''); // usu≈Ñ 's' na ko≈Ñcu
  
  try {
    await exportService.export(id, normalizedType);
  } catch (error) {
    console.error('Export error:', error);
    alert(`B≈ÇƒÖd eksportu: ${error.message}`);
  }
}
```

**‚úÖ Test**: Test manualny eksportu

---

#### **KROK 8: Ekstrakcja `card-renderer.js` + `error-handler.js`**
**Priorytet**: üü° ≈öREDNI  
**Czas**: 2-3 godziny

**Nowy plik: `js/ui/components/card-renderer.js`**:
```javascript
/**
 * @fileoverview Komponent renderowania kart tre≈õci
 */

export class CardRenderer {
  /**
   * Renderuje listƒô kart
   * @param {Array} items - Tablica element√≥w (quizzes/workouts/listening)
   * @param {'quiz'|'workout'|'listening'|'kb'} type - Typ tre≈õci
   * @param {Object} currentUser - Aktualny u≈ºytkownik
   * @returns {string} - HTML string
   */
  render(items, type, currentUser) {
    if (!items || items.length === 0) {
      return this.renderEmpty(type);
    }
    
    return items.map(item => this.renderCard(item, type, currentUser)).join('');
  }

  /**
   * Renderuje pojedynczƒÖ kartƒô
   */
  renderCard(item, type, currentUser) {
    const icon = this.getIcon(item, type);
    const badge = this.getBadge(item);
    const actionButtons = this.getActionButtons(item, type, currentUser);
    const description = this.getDescription(item, type);
    
    return `
      <div class="content-card bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 hover:shadow-lg transition-shadow" 
           data-id="${item.id}" 
           data-type="${type}">
        
        <!-- Header -->
        <div class="flex items-start justify-between mb-2">
          <div class="flex items-center gap-2">
            <span class="text-3xl">${icon}</span>
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
              ${item.title}
            </h3>
          </div>
          ${badge}
        </div>
        
        <!-- Description -->
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
          ${description}
        </p>
        
        <!-- Action Buttons -->
        <div class="flex gap-2">
          ${actionButtons}
        </div>
      </div>
    `;
  }

  /**
   * Pusty stan
   */
  renderEmpty(type) {
    const messages = {
      quiz: 'Brak quiz√≥w. Zaimportuj lub wygeneruj nowy quiz.',
      workout: 'Brak trening√≥w. Zaimportuj lub wygeneruj nowy trening.',
      listening: 'Brak zestaw√≥w. Zaimportuj lub wygeneruj nowy zestaw.',
      kb: 'Brak artyku≈Ç√≥w w bazie wiedzy.'
    };
    
    return `
      <div class="text-center py-12 text-gray-500 dark:text-gray-400">
        <p class="text-lg">${messages[type] || 'Brak tre≈õci'}</p>
      </div>
    `;
  }

  getIcon(item, type) {
    return item.icon || this.getDefaultIcon(type);
  }

  getDefaultIcon(type) {
    const defaults = {
      quiz: 'üìù',
      workout: 'üí™',
      listening: 'üéß',
      kb: 'üìö'
    };
    return defaults[type] || 'üìÑ';
  }

  getBadge(item) {
    if (item.is_public) {
      return '<span class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded">Publiczny</span>';
    }
    return '<span class="px-2 py-1 text-xs bg-gray-100 text-gray-800 rounded">Prywatny</span>';
  }

  getDescription(item, type) {
    if (type === 'quiz') {
      return `${item.questions?.length || 0} pyta≈Ñ`;
    } else if (type === 'workout') {
      return `${item.phases?.length || 0} faz`;
    } else if (type === 'listening') {
      return `${item.phrases?.length || 0} fraz (${item.sourceLang} ‚Üí ${item.targetLang})`;
    } else if (type === 'kb') {
      return item.description || 'Artyku≈Ç bazy wiedzy';
    }
    return '';
  }

  getActionButtons(item, type, currentUser) {
    const isOwner = currentUser && item.user_id === currentUser.id;
    
    let buttons = `
      <button class="btn-start px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700" 
              data-id="${item.id}">
        Rozpocznij
      </button>
    `;
    
    if (isOwner) {
      buttons += `
        <button class="btn-export px-3 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300" 
                data-id="${item.id}" 
                title="Eksportuj do JSON">
          üì•
        </button>
        <button class="btn-delete px-3 py-2 bg-red-100 text-red-700 rounded hover:bg-red-200" 
                data-id="${item.id}" 
                title="Usu≈Ñ">
          üóëÔ∏è
        </button>
      `;
    }
    
    return buttons;
  }
}

// Singleton
export const cardRenderer = new CardRenderer();
```

**Nowy plik: `js/services/error-handler.js`**:
```javascript
/**
 * @fileoverview Centralna obs≈Çuga b≈Çƒôd√≥w
 */

export class ErrorHandler {
  constructor() {
    this.errorLog = [];
  }

  /**
   * Obs≈Çuguje b≈ÇƒÖd
   * @param {Error} error - Obiekt b≈Çƒôdu
   * @param {string} context - Kontekst (np. 'import', 'ai-generate')
   */
  handle(error, context = 'unknown') {
    const errorInfo = {
      message: error.message,
      context: context,
      timestamp: new Date().toISOString(),
      stack: error.stack
    };
    
    // Log do konsoli
    console.error(`[${context}]`, error);
    
    // Zapisz do logu
    this.errorLog.push(errorInfo);
    
    // Limit logu do 50 ostatnich b≈Çƒôd√≥w
    if (this.errorLog.length > 50) {
      this.errorLog.shift();
    }
    
    // TODO: W przysz≈Ço≈õci - wysy≈Çka do Sentry/LogRocket
  }

  /**
   * Pobiera ostatnie b≈Çƒôdy
   */
  getRecentErrors(limit = 10) {
    return this.errorLog.slice(-limit);
  }

  /**
   * Czy≈õci log
   */
  clear() {
    this.errorLog = [];
  }
}

// Singleton
export const errorHandler = new ErrorHandler();
```

**Update `js/content-manager.js`**:
```javascript
import { cardRenderer } from './ui/components/card-renderer.js';
import { errorHandler } from './services/error-handler.js';

// Zamie≈Ñ renderCards:
renderCards(state, elements, uiManager, sessionManager) {
  const currentTab = state.currentTab;
  const currentUser = state.currentUser;
  
  let items, type;
  
  if (currentTab === 'quizzes') {
    items = state.quizzes;
    type = 'quiz';
  } else if (currentTab === 'workouts') {
    items = state.workouts;
    type = 'workout';
  } else if (currentTab === 'listening') {
    items = state.listeningSets;
    type = 'listening';
  } else if (currentTab === 'knowledge-base') {
    // KB ma osobnƒÖ logikƒô (na razie zostaw)
    return;
  }
  
  try {
    // DELEGUJ do CardRenderer
    const html = cardRenderer.render(items, type, currentUser);
    elements.contentGrid.innerHTML = html;
    
    // Attach event listeners
    this.attachCardEventListeners(elements, state, uiManager, sessionManager);
    
  } catch (error) {
    errorHandler.handle(error, 'render-cards');
    uiManager.showError('B≈ÇƒÖd renderowania kart');
  }
}
```

**‚úÖ Test**: 
```bash
npm test
# + Test manualny renderowania kart
```

---

### üèóÔ∏è FAZA 3: Unifikacja Silnik√≥w (Kroki 9-12)

#### **KROK 9: Utworzenie `base-engine.js`**
**Priorytet**: üî¥ WYSOKI (fundament)  
**Czas**: 1 godzina

**Nowy plik: `js/engines/base-engine.js`**:
```javascript
/**
 * @fileoverview Bazowa klasa dla wszystkich silnik√≥w tre≈õci
 * Definiuje jednolity interfejs dla quiz, workout, listening, KB
 */

export class BaseEngine {
  /**
   * @param {Object} elements - Referencje do element√≥w DOM
   */
  constructor(elements) {
    this.elements = elements;
    this.isInitialized = false;
    this.isActive = false;
  }

  // ========== LIFECYCLE METHODS (do implementacji w subclassach) ==========

  /**
   * Inicjalizacja silnika (event listeners, setup)
   */
  init() {
    throw new Error(`${this.constructor.name}.init() not implemented`);
  }

  /**
   * Rozpocznij aktywno≈õƒá
   * @param {Object} data - Dane (quiz/workout/listening)
   * @param {string} id - ID tre≈õci
   * @param {Object} options - Dodatkowe opcje
   */
  start(data, id, options = {}) {
    throw new Error(`${this.constructor.name}.start() not implemented`);
  }

  /**
   * Pauza
   */
  pause() {
    throw new Error(`${this.constructor.name}.pause() not implemented`);
  }

  /**
   * Wzn√≥w
   */
  resume() {
    throw new Error(`${this.constructor.name}.resume() not implemented`);
  }

  /**
   * Zatrzymaj i wyczy≈õƒá
   */
  stop() {
    throw new Error(`${this.constructor.name}.stop() not implemented`);
  }

  /**
   * Restart od poczƒÖtku
   */
  restart() {
    throw new Error(`${this.constructor.name}.restart() not implemented`);
  }

  // ========== STATE MANAGEMENT ==========

  /**
   * Pobierz aktualny postƒôp
   * @returns {Object} - { current, total, percentage, ... }
   */
  getProgress() {
    throw new Error(`${this.constructor.name}.getProgress() not implemented`);
  }

  /**
   * Zapisz postƒôp (do localStorage lub Supabase)
   */
  saveProgress() {
    // Default: do nothing (opcjonalne w subclassach)
  }

  /**
   * Wczytaj postƒôp
   * @returns {Object|null} - Zapisany stan lub null
   */
  loadProgress() {
    // Default: do nothing (opcjonalne w subclassach)
    return null;
  }

  // ========== HELPER METHODS ==========

  /**
   * Sprawd≈∫ czy silnik jest zainicjalizowany
   */
  ensureInitialized() {
    if (!this.isInitialized) {
      throw new Error(`${this.constructor.name} not initialized. Call init() first.`);
    }
  }
}
```

**‚úÖ Test**: Tylko utworzenie pliku, bez zmian w istniejƒÖcym kodzie

---

#### **KROK 10: Refactoring `quiz-engine.js` do klasy**
**Priorytet**: üî¥ KRYTYCZNY  
**Czas**: 4-5 godzin

**‚ö†Ô∏è UWAGA**: To najwiƒôksza zmiana w tej fazie. Przekszta≈Çcamy IIFE w klasƒô.

**Backup przed zmianƒÖ**:
```bash
cp js/quiz-engine.js js/quiz-engine.js.backup
```

**Nowy `js/engines/quiz-engine.js`**:
```javascript
/**
 * @fileoverview Silnik quiz√≥w (refactored do klasy)
 */

import { BaseEngine } from './base-engine.js';
import { playSound } from '../utils/audio.js';

export class QuizEngine extends BaseEngine {
  constructor(elements) {
    super(elements);
    
    // Lokalny stan quizu (enkapsulowany!)
    this.quizState = {
      data: null,
      id: null,
      currentQuestionIndex: 0,
      score: 0,
      answers: [],
      mistakeQuestions: [],
      isMistakesMode: false
    };
  }

  // ========== LIFECYCLE ==========

  init() {
    this.setupElements();
    this.attachEventListeners();
    this.isInitialized = true;
    console.log('‚úÖ QuizEngine initialized');
  }

  start(quizData, quizId, options = {}) {
    this.ensureInitialized();
    
    // Reset state
    this.quizState = {
      data: quizData,
      id: quizId,
      currentQuestionIndex: 0,
      score: 0,
      answers: [],
      mistakeQuestions: [],
      isMistakesMode: options.mistakesOnly || false
    };
    
    this.isActive = true;
    
    // Poka≈º opcje quizu (normal vs mistakes)
    if (!options.mistakesOnly) {
      this.showQuizOptions();
    } else {
      this.startQuiz();
    }
  }

  pause() {
    // Quiz nie ma pauzy, ale mo≈ºemy zapisaƒá postƒôp
    this.saveProgress();
  }

  resume() {
    const progress = this.loadProgress();
    if (progress) {
      this.quizState = { ...this.quizState, ...progress };
      this.displayQuestion();
    }
  }

  stop() {
    this.isActive = false;
    this.quizState = {
      data: null,
      id: null,
      currentQuestionIndex: 0,
      score: 0,
      answers: [],
      mistakeQuestions: [],
      isMistakesMode: false
    };
  }

  restart() {
    const data = this.quizState.data;
    const id = this.quizState.id;
    this.stop();
    this.start(data, id);
  }

  // ========== QUIZ LOGIC (skopiuj z oryginalnego quiz-engine.js) ==========

  setupElements() {
    // Pobierz referencje do element√≥w DOM
    this.questionEl = this.elements.quizQuestion;
    this.optionsEl = this.elements.quizOptions;
    this.progressEl = this.elements.quizProgress;
    this.scoreEl = this.elements.quizScore;
    // ... etc
  }

  attachEventListeners() {
    // Event listeners dla przycisk√≥w
    this.elements.quizRestartBtn?.addEventListener('click', () => this.restart());
    this.elements.quizExitBtn?.addEventListener('click', () => this.exitQuiz());
    // ... etc
  }

  showQuizOptions() {
    // Poka≈º modal z opcjami (normalny quiz vs tylko b≈Çƒôdy)
    // Skopiuj logikƒô z oryginalnego pliku
  }

  startQuiz() {
    this.displayQuestion();
  }

  displayQuestion() {
    const { data, currentQuestionIndex, isMistakesMode, mistakeQuestions } = this.quizState;
    
    const questions = isMistakesMode ? mistakeQuestions : data.questions;
    
    if (currentQuestionIndex >= questions.length) {
      this.showSummary();
      return;
    }
    
    const question = questions[currentQuestionIndex];
    
    // Render pytania
    this.questionEl.textContent = question.question;
    
    // Render opcji
    this.optionsEl.innerHTML = question.options.map((option, idx) => `
      <button class="quiz-option" data-index="${idx}">
        ${option}
      </button>
    `).join('');
    
    // Attach listeners do opcji
    this.optionsEl.querySelectorAll('.quiz-option').forEach(btn => {
      btn.addEventListener('click', (e) => this.handleAnswer(e));
    });
    
    // Update progress
    this.updateProgress();
  }

  handleAnswer(event) {
    const selectedIndex = parseInt(event.target.dataset.index);
    const { data, currentQuestionIndex, isMistakesMode, mistakeQuestions } = this.quizState;
    
    const questions = isMistakesMode ? mistakeQuestions : data.questions;
    const question = questions[currentQuestionIndex];
    const isCorrect = selectedIndex === question.correctAnswer;
    
    // Zapisz odpowied≈∫
    this.quizState.answers.push({
      questionIndex: currentQuestionIndex,
      selectedAnswer: selectedIndex,
      correctAnswer: question.correctAnswer,
      isCorrect: isCorrect
    });
    
    // Update score
    if (isCorrect) {
      this.quizState.score++;
      playSound('correct');
    } else {
      playSound('wrong');
      // Dodaj do b≈Çƒôd√≥w (je≈õli nie jest ju≈º w mistakes mode)
      if (!isMistakesMode) {
        this.quizState.mistakeQuestions.push(question);
      }
    }
    
    // Poka≈º feedback
    this.showFeedback(isCorrect, question);
    
    // Nastƒôpne pytanie (po 1.5s)
    setTimeout(() => {
      this.quizState.currentQuestionIndex++;
      this.displayQuestion();
    }, 1500);
  }

  showFeedback(isCorrect, question) {
    // Poka≈º feedback (zielony/czerwony)
    // Skopiuj logikƒô z oryginalnego pliku
  }

  showSummary() {
    const { score, answers, data, mistakeQuestions } = this.quizState;
    const total = answers.length;
    const percentage = Math.round((score / total) * 100);
    
    // Render summary
    // Skopiuj logikƒô z oryginalnego pliku
    
    // Opcja "Powt√≥rz b≈Çƒôdy" je≈õli sƒÖ b≈Çƒôdy
    if (mistakeQuestions.length > 0) {
      // Poka≈º przycisk "Powt√≥rz b≈Çƒôdy"
    }
    
    this.isActive = false;
  }

  updateProgress() {
    const { currentQuestionIndex, data } = this.quizState;
    const total = data.questions.length;
    this.progressEl.textContent = `Pytanie ${currentQuestionIndex + 1} / ${total}`;
  }

  exitQuiz() {
    if (confirm('Czy na pewno chcesz wyj≈õƒá? Postƒôp zostanie utracony.')) {
      this.stop();
      // Nawiguj do g≈Ç√≥wnego ekranu
      if (window.uiManager) {
        window.uiManager.showScreen('main', window.state, window.elements);
      }
    }
  }

  // ========== STATE MANAGEMENT ==========

  getProgress() {
    const { currentQuestionIndex, data } = this.quizState;
    return {
      current: currentQuestionIndex + 1,
      total: data?.questions.length || 0,
      percentage: data ? Math.round(((currentQuestionIndex + 1) / data.questions.length) * 100) : 0
    };
  }

  saveProgress() {
    // Opcjonalnie: zapisz do localStorage
    localStorage.setItem(`quiz-progress-${this.quizState.id}`, JSON.stringify(this.quizState));
  }

  loadProgress() {
    const saved = localStorage.getItem(`quiz-progress-${this.quizState.id}`);
    return saved ? JSON.parse(saved) : null;
  }

  // ========== PUBLIC API (dla backward compatibility) ==========

  resetMistakes() {
    this.quizState.mistakeQuestions = [];
  }
}

// ========== BACKWARD COMPATIBILITY (TEMPORARY!) ==========
// Eksportuj do window.* aby stary kod dzia≈Ça≈Ç

let quizEngineInstance = null;

export function initQuizEngine(elements) {
  if (!quizEngineInstance) {
    quizEngineInstance = new QuizEngine(elements);
    quizEngineInstance.init();
  }
  return quizEngineInstance;
}

// Globalne API (do usuniƒôcia w Kroku 15)
if (typeof window !== 'undefined') {
  window.initQuizEngine = (elements) => initQuizEngine(elements);
  window.startQuiz = (data, id, options) => {
    if (quizEngineInstance) {
      quizEngineInstance.start(data, id, options);
    }
  };
  window.resetMistakes = () => {
    if (quizEngineInstance) {
      quizEngineInstance.resetMistakes();
    }
  };
}
```

**Update `js/app.js`**:
```javascript
// Zmie≈Ñ import
import { initQuizEngine } from './engines/quiz-engine.js';

// W funkcji init():
const quizEngine = initQuizEngine(elements);
```

**‚úÖ Test**: 
```bash
npm test
# + Test manualny: uruchom quiz, sprawd≈∫ czy dzia≈Ça identycznie jak przed refaktoringiem
```

---

#### **KROK 11: Refactoring `workout-engine.js` do klasy**
**Priorytet**: üî¥ KRYTYCZNY  
**Czas**: 4-5 godzin

**Analogicznie do quiz-engine.js**:
1. Backup: `cp js/workout-engine.js js/workout-engine.js.backup`
2. Utw√≥rz `js/engines/workout-engine.js` jako klasƒô dziedziczƒÖcƒÖ po `BaseEngine`
3. Enkapsuluj `workoutState` w klasie
4. Dodaj backward compatibility przez `window.*`
5. Update `js/app.js` aby u≈ºywa≈Ç nowego importu

**‚úÖ Test**: `npm test` + test manualny trening√≥w

---

#### **KROK 12: Refactoring `listening-engine.js` do klasy**
**Priorytet**: üî¥ KRYTYCZNY  
**Czas**: 4-5 godzin

**Analogicznie**:
1. Backup: `cp js/listening-engine.js js/listening-engine.js.backup`
2. Utw√≥rz `js/engines/listening-engine.js` jako klasƒô
3. Enkapsuluj `playerState` w klasie
4. Backward compatibility
5. Update `js/app.js`

**‚úÖ Test**: `npm test` + test manualny listening

---

### üß≠ FAZA 4: Centralna Nawigacja (Kroki 13-14)

#### **KROK 13: Utworzenie `router.js`**
**Priorytet**: üü° ≈öREDNI  
**Czas**: 3-4 godziny

**Nowy plik: `js/core/router.js`**:
```javascript
/**
 * @fileoverview Centralny router aplikacji
 */

import { appState } from '../state/app-state.js';

/**
 * Bazowa klasa dla ekran√≥w
 */
export class Screen {
  constructor(name, element, options = {}) {
    this.name = name;
    this.element = element;
    this.isActivity = options.isActivity || false;
  }

  show(options = {}) {
    this.element.classList.remove('hidden');
    this.onShow(options);
  }

  hide() {
    this.element.classList.add('hidden');
    this.onHide();
  }

  // Do nadpisania w subclassach
  onShow(options) {}
  onHide() {}
}

/**
 * Router - centralna nawigacja
 */
export class Router {
  constructor(screens) {
    this.screens = screens; // Map<string, Screen>
    this.currentScreen = null;
    this.history = [];
  }

  /**
   * Nawiguj do ekranu
   */
  navigate(screenName, options = {}) {
    console.log(`üß≠ Router: navigating to ${screenName}`);
    
    // 1. Ukryj obecny ekran
    if (this.currentScreen) {
      this.currentScreen.hide();
      this.history.push(this.currentScreen.name);
    }

    // 2. Pobierz docelowy ekran
    const screen = this.screens.get(screenName);
    if (!screen) {
      console.error(`Screen not found: ${screenName}`);
      return;
    }

    // 3. Zaktualizuj globalny stan
    appState.setState({
      currentScreen: screenName,
      isActivity: screen.isActivity,
      showTabBar: !screen.isActivity
    });

    // 4. Poka≈º nowy ekran
    screen.show(options);
    this.currentScreen = screen;
  }

  /**
   * Wr√≥ƒá do poprzedniego ekranu
   */
  back() {
    if (this.history.length > 0) {
      const previousScreen = this.history.pop();
      this.navigate(previousScreen);
    } else {
      // Fallback: wr√≥ƒá do main
      this.navigate('main');
    }
  }

  /**
   * Pobierz aktualny ekran
   */
  getCurrentScreen() {
    return this.currentScreen;
  }
}
```

**Update `js/ui-manager.js` - dodaj backward compatibility**:
```javascript
import { router } from '../core/router.js'; // Bƒôdzie utworzony w app.js

// W showScreen - dodaj delegacjƒô do routera
showScreen(screenName, state, elements, contentManager, sessionManager) {
  // NOWY SPOS√ìB: deleguj do routera
  if (window.router) {
    window.router.navigate(screenName, { state, elements, contentManager, sessionManager });
  }
  
  // STARY SPOS√ìB: zachowaj na razie (fallback)
  // ... istniejƒÖcy kod ...
}
```

**‚úÖ Test**: `npm test` + test nawigacji

---

#### **KROK 14: Migracja ekran√≥w do `ui/screens/`**
**Priorytet**: üü¢ NISKI (optional, ale zalecane)  
**Czas**: 4-5 godzin

**Przyk≈Çad: `js/ui/screens/quiz-screen.js`**:
```javascript
import { Screen } from '../../core/router.js';

export class QuizScreen extends Screen {
  constructor(element, quizEngine) {
    super('quiz', element, { isActivity: true });
    this.quizEngine = quizEngine;
  }

  onShow(options) {
    const { quizId, quizData } = options;
    this.quizEngine.start(quizData, quizId);
  }

  onHide() {
    // Cleanup if needed
  }
}
```

**Podobnie dla**: `workout-screen.js`, `listening-screen.js`, `main-screen.js`, `kb-screen.js`

**Update `js/app.js`**:
```javascript
import { Router } from './core/router.js';
import { QuizScreen } from './ui/screens/quiz-screen.js';
// ... inne ekrany

// Inicjalizacja routera
const router = new Router(new Map([
  ['quiz', new QuizScreen(elements.quizScreen, quizEngine)],
  ['workout', new WorkoutScreen(elements.workoutScreen, workoutEngine)],
  ['listening', new ListeningScreen(elements.listeningScreen, listeningEngine)],
  ['main', new MainScreen(elements.mainScreen)],
  // ...
]));

window.router = router; // Backward compatibility
```

**‚úÖ Test**: `npm test` + test wszystkich ekran√≥w

---

### üóëÔ∏è FAZA 5: Finalizacja - Usuniƒôcie Duplikacji (Kroki 15-18)

**‚ö†Ô∏è KRYTYCZNE**: Ta faza u≈ºywa **Strangler Fig Pattern** - migrujemy modu≈Ç po module!

#### **KROK 15a: Migracja `quiz-engine` do wy≈ÇƒÖcznego u≈ºycia `appState`**
**Priorytet**: üî¥ KRYTYCZNY  
**Czas**: 2 godziny

**Akcje**:
1. W `quiz-engine.js`: zamie≈Ñ wszystkie `window.state.X` na `appState.getState().X`
2. Usu≈Ñ synchronizacjƒô w `app.js` dla danych zwiƒÖzanych z quizami
3. Test: `npm test` + test quiz√≥w

---

#### **KROK 15b: Migracja `workout-engine` do `appState`**
**Priorytet**: üî¥ KRYTYCZNY  
**Czas**: 2 godziny

Analogicznie do 15a.

---

#### **KROK 15c: Migracja `listening-engine` do `appState`**
**Priorytet**: üî¥ KRYTYCZNY  
**Czas**: 2 godziny

Analogicznie do 15a.

---

#### **KROK 15d: Usuniƒôcie starego `state` z `app.js`**
**Priorytet**: üî¥ KRYTYCZNY  
**Czas**: 2-3 godziny

**Akcje**:
1. Usu≈Ñ obiekt `state` z `app.js`
2. Usu≈Ñ `window.state = state;`
3. Zamie≈Ñ wszystkie `state.X` na `appState.getState().X` w ca≈Çym projekcie
4. Usu≈Ñ synchronizacjƒô miƒôdzy stanami

**‚úÖ Test**: `npm test` - **MUST PASS!**

---

#### **KROK 16: Merge `ui-state.js` do `app-state.js`**
**Priorytet**: üü° ≈öREDNI  
**Czas**: 2 godziny

**Dlaczego?** `ui-state.js` i `app-state.js` zarzƒÖdzajƒÖ tymi samymi danymi (currentScreen, currentTab, showTabBar).

**Akcje**:
1. Przenie≈õ logikƒô z `ui-state.js` (np. `navigateToScreen`) do `app-state.js` jako helper functions
2. Update wszystkie importy `ui-state.js` ‚Üí `app-state.js`
3. Usu≈Ñ plik `js/ui-state.js`

**‚úÖ Test**: `npm test`

---

#### **KROK 17: Cleanup - usuniƒôcie backward compatibility**
**Priorytet**: üü¢ NISKI  
**Czas**: 2-3 godziny

**Akcje**:
1. Usu≈Ñ wszystkie `window.*` API:
   - `window.startQuiz`
   - `window.startWorkout`
   - `window.initQuizEngine`
   - etc.

2. Usu≈Ñ fallback code w `ui-manager.js` (stara implementacja `showScreen`)

3. Usu≈Ñ IIFE wrappery z silnik√≥w (je≈õli jeszcze sƒÖ)

4. Update `index.html` - zamie≈Ñ na ES6 modules:
```html
<!-- PRZED -->
<script src="js/state-manager.js"></script>
<script src="js/ui-state.js"></script>
<script src="js/app.js"></script>

<!-- PO -->
<script type="module" src="js/core/app.js"></script>
```

**‚úÖ Test**: `npm test` + pe≈Çne testy regresyjne manualne

---

#### **KROK 18: Implementacja paginacji w `data-service.js`**
**Priorytet**: üü° ≈öREDNI (skalowalno≈õƒá)  
**Czas**: 3-4 godziny

**Problem**: `loadData` pobiera wszystkie quizy/treningi naraz. Przy 500+ elementach aplikacja siƒô zawiesza.

**RozwiƒÖzanie**: Lazy loading + paginacja.

**Update `js/data-service.js`**:
```javascript
/**
 * Pobiera quizy z paginacjƒÖ
 * @param {number} page - Numer strony (0-based)
 * @param {number} pageSize - Rozmiar strony (default: 20)
 * @returns {Promise<{data: Array, hasMore: boolean}>}
 */
async fetchQuizzesPaginated(page = 0, pageSize = 20) {
  const { data, error } = await supabase
    .from('quizzes')
    .select('*')
    .order('created_at', { ascending: false })
    .range(page * pageSize, (page + 1) * pageSize - 1);
  
  if (error) throw error;
  
  return {
    data: data || [],
    hasMore: data.length === pageSize
  };
}

// Analogicznie dla workouts i listening
```

**Update `js/content-manager.js`**:
```javascript
async loadData(state, elements, uiManager) {
  // Zamiast pobieraƒá wszystko naraz, pobierz pierwszƒÖ stronƒô
  const page = 0;
  const pageSize = 20;
  
  if (state.currentTab === 'quizzes') {
    const result = await dataService.fetchQuizzesPaginated(page, pageSize);
    state.quizzes = result.data;
    
    // Je≈õli sƒÖ kolejne strony, dodaj przycisk "Za≈Çaduj wiƒôcej"
    if (result.hasMore) {
      this.showLoadMoreButton(elements, 'quizzes');
    }
  }
  // ... analogicznie dla workouts, listening
}

showLoadMoreButton(elements, type) {
  // Dodaj przycisk "Za≈Çaduj wiƒôcej" na dole listy
}
```

**‚úÖ Test**: Test manualny z du≈ºƒÖ ilo≈õciƒÖ danych

---

## üìä Metryki Sukcesu

### Przed refaktoringiem:
| Metryka | Warto≈õƒá |
|---------|---------|
| Liczba plik√≥w w `/js/` | 17 |
| Najwiƒôkszy plik | `content-manager.js` (2015 linii) |
| ZarzƒÖdzanie stanem | 3 r√≥≈ºne sposoby |
| Duplikacja logiki | `showScreen` w 2 miejscach |
| Globalna przestrze≈Ñ (`window.*`) | ~15 obiekt√≥w |
| Wzorzec silnik√≥w | Niesp√≥jny (IIFE vs ES6) |
| Build tools | Brak (network waterfall) |

### Po refaktoringu:
| Metryka | Cel |
|---------|-----|
| Struktura katalog√≥w | 6 warstw (core, state, services, engines, ui, utils) |
| Najwiƒôkszy plik | <500 linii |
| ZarzƒÖdzanie stanem | 1 spos√≥b (`appState` + lokalne store'y w silnikach) |
| Duplikacja logiki | 0 (centralna `Router`) |
| Globalna przestrze≈Ñ | 0 (ES6 modules) |
| Wzorzec silnik√≥w | Jednolity (`BaseEngine` + classes) |
| Build tools | Vite (HMR + bundling) |
| Testy | 100% pass rate |

---

## ‚ö†Ô∏è Ryzyka i Mitygacja

### Ryzyko 1: Regresje w dzia≈Çaniu aplikacji
- **Mitygacja**: Incremental refactoring - ka≈ºdy krok testowany
- **Checkpoint**: Po ka≈ºdym kroku: `npm test` + test manualny
- **Rollback**: Git commit po ka≈ºdym kroku

### Ryzyko 2: D≈Çugi czas refaktoringu
- **Mitygacja**: Timeboxing - ka≈ºda faza max 2-3 dni
- **Checkpoint**: Po ka≈ºdej fazie - code review

### Ryzyko 3: Merge conflicts
- **Mitygacja**: Refactoring w osobnym branchu `refactor/architecture-2025`
- **Best practice**: Freeze feature development podczas refaktoringu

### Ryzyko 4: Performance regression po wprowadzeniu Vite
- **Mitygacja**: Benchmark przed i po (Lighthouse, WebPageTest)
- **Expected**: Poprawa performance dziƒôki bundlingowi

---

## üéØ Harmonogram (Estimation)

| Faza | Kroki | Czas | Priorytet |
|------|-------|------|-----------|
| **Faza 0: Build Tools** | Krok 0 | 0.5 dnia | üî¥ KRYTYCZNY |
| **Faza 1: Przygotowanie** | Kroki 1-3 | 1 dzie≈Ñ | üî¥ WYSOKI |
| **Faza 2: God Object** | Kroki 4-8 | 3 dni | üî¥ KRYTYCZNY |
| **Faza 3: Silniki** | Kroki 9-12 | 3 dni | üî¥ KRYTYCZNY |
| **Faza 4: Nawigacja** | Kroki 13-14 | 1.5 dnia | üü° ≈öREDNI |
| **Faza 5: Finalizacja** | Kroki 15-18 | 2 dni | üî¥ KRYTYCZNY |
| **TOTAL** | 18 krok√≥w | **10-12 dni** | |

---

## ‚úÖ Checklist przed rozpoczƒôciem

- [ ] Backup ca≈Çego projektu
- [ ] Utworzenie brancha `refactor/architecture-2025`
- [ ] Komunikacja z zespo≈Çem (freeze feature development)
- [ ] Przygotowanie ≈õrodowiska testowego
- [ ] Zainstalowanie Vite: `npm install --save-dev vite`

---

## üìù Nastƒôpne Kroki

1. ‚úÖ **Akceptacja tego planu przez managera**
2. ‚úÖ **Utworzenie branch `refactor/architecture-2025`**
3. ‚úÖ **Rozpoczƒôcie od Fazy 0 (Krok 0: Vite setup)**
4. ‚úÖ **Daily standupy - raportowanie postƒôpu**
5. ‚úÖ **Code review po ka≈ºdej fazie**
6. ‚úÖ **Merge do main po zako≈Ñczeniu ca≈Ço≈õci**

---

## ü§ù Podsumowanie

Ten plan jest **syntezƒÖ dw√≥ch niezale≈ºnych analiz architektonicznych**. ≈ÅƒÖczy:
- ‚úÖ Szczeg√≥≈Çowy, krok-po-kroku plan refaktoringu
- ‚úÖ Pragmatyczne podej≈õcie (build tools, paginacja, error handling)
- ‚úÖ BezpiecznƒÖ strategiƒô migracji (Strangler Fig Pattern)
- ‚úÖ Hybrydowe zarzƒÖdzanie stanem (globalny + lokalne)

**Kluczowe usprawnienia wzglƒôdem oryginalnej analizy**:
1. **Krok 0 (Vite)** - rozwiƒÖzuje problem network waterfall
2. **Rozbicie Kroku 13 na 15a-d** - bezpieczniejsza migracja stanu
3. **Krok 18 (paginacja)** - skalowalno≈õƒá danych
4. **Error handler** - centralna obs≈Çuga b≈Çƒôd√≥w
5. **Jasna strategia stanu** - globalny tylko dla user/navigation, lokalne w silnikach

---

**Document Version**: 2.0 (FINAL)  
**Last Updated**: 2025-11-01  
**Authors**: Zesp√≥≈Ç Architektury  
**Status**: ‚úÖ **ZATWIERDZONY - GOTOWY DO IMPLEMENTACJI**

---

**Pytania? WƒÖtpliwo≈õci?**  
üìß Skontaktuj siƒô z team leadem przed rozpoczƒôciem implementacji.

**Good luck! üöÄ**

